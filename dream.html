<script>
  document.addEventListener('DOMContentLoaded', () => {
    const KEY = 'dodva_dreams_v1';
    const $list = document.getElementById('list');

    renderNotice('加载中…');

    fetch('dreams.json?_=' + Date.now())
      .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(arr => { if(!Array.isArray(arr) || !arr.length) throw new Error('empty_json'); render(arr); })
      .catch(() => {
        let arr = [];
        try { arr = JSON.parse(localStorage.getItem(KEY)) || []; } catch(e){ arr = []; }
        render(arr);
      });

    function render(list){
      if (!Array.isArray(list) || !list.length) { renderNotice('暂无梦境，去“上传梦境”或 Dream Map 添加吧～'); return; }
      $list.innerHTML = list.map(d => `
        <div class="dream-card">
          <div class="tag">${safe(dateStr(d.createdAt))}</div>
          <h3>${safe(d.title || '未命名梦境')}</h3>
          <div class="tag">by ${safe(d.nickname || '匿名')}${(d.tags&&d.tags.length)?' · '+d.tags.map(safe).join(' · '):''}</div>
          ${d.image ? `<img src="${d.image}" alt="dream" />` : ''}
          <p>${safe(d.description || '')}</p>
          ${(typeof d.lat==='number' && typeof d.lng==='number') ? `<div class="tag">坐标：${d.lat}, ${d.lng}</div>` : ''}
        </div>`).join('');
    }
    function renderNotice(t){ $list.innerHTML = `<p class="notice">${safe(t)}</p>`; }
    function safe(s){ return (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function dateStr(iso){ try{ return iso ? new Date(iso).toLocaleString() : ''; }catch{ return ''; } }
  });
</script>
