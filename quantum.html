<!DOCTYPE html>
<html lang="zh-CN">
<head>
 <nav style="margin:10px 0; display:flex; gap:10px; flex-wrap:wrap">
  <a class="btn" href=" ">Quantum å®éªŒå®¤</a >
  <a class="btn" href="toys.html?u=xinyue">DODVA æ¦‚å¿µç©å…·æŸœ</a >
</nav>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dodva Quantum Playground Â· åŒç¼ Ã— å»¶è¿Ÿé€‰æ‹©</title>
<style>
  :root{--bg:#07070c;--ink:#eaeaff;--mut:#9aa0b3;--panel:#111222;--line:#2a2f48;--glow:#9f8fff}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:18px 14px}
  h1{margin:6px 0 10px;font-size:22px}
  .mut{color:var(--mut);font-size:13px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px 12px 14px;box-shadow:0 8px 28px rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px;grid-template-columns:1.1fr .9fr}
  .controls{display:grid;gap:10px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{cursor:pointer;border:1px solid #394056;background:transparent;color:var(--ink);
       border-radius:10px;padding:7px 12px}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  input[type="range"]{width:160px}
  .tag{border:1px solid #394056;border-radius:999px;padding:2px 8px;font-size:12px}
  canvas{width:100%;height:520px;background:radial-gradient(450px 300px at 50% 30%,rgba(255,255,255,.06),transparent 60%)}
  .small{font-size:12px}
  /* å¿ƒå½¢ç²’å­ */
  .hearts{position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;overflow:hidden}
  .heart{position:absolute;bottom:12%;font-size:18px;opacity:.9;animation:rise 1.6s ease-out forwards}
  @keyframes rise{from{transform:translateY(0) scale(.9);opacity:.9} to{transform:translateY(-220px) scale(1.4);opacity:0}}
  /* æ˜Ÿå…‰é—ª */
  body.flash{background:
    radial-gradient(1200px 600px at 50% 50%,rgba(255,255,255,.09),transparent 40%) no-repeat var(--bg);
    transition:background .25s ease}
  details{margin-top:10px}
  summary{cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dodva Quantum Playground âœ¨ <span class="mut">åƒç©æ¸¸æˆä¸€æ ·æ€è€ƒç‰©ç†ä¸åˆ›é€ </span></h1>

  <div class="grid">
    <!-- å·¦ï¼šç”»å¸ƒ -->
    <section class="panel">
      <canvas id="screen" width="900" height="520"></canvas>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div class="row small">
          <span class="tag">å‡»ä¸­æ•° <b id="hits">0</b></span>
          <span class="tag">æ¨¡å¼ <b id="modeText">æ³¢ï¼ˆå¹²æ¶‰ï¼‰</b></span>
          <span class="tag">å»¶è¿Ÿå¸§ <b id="delayText">12</b></span>
        </div>
        <div class="row">
          <button class="btn" id="btnReset">é‡ç½®</button>
          <button class="btn" id="btnShot">ä¿å­˜æˆªå›¾</button>
        </div>
      </div>
    </section>

    <!-- å³ï¼šæ§åˆ¶å° -->
    <section class="panel controls">
      <div class="row">
        <label><input type="checkbox" id="observe"> è§‚å¯Ÿï¼ˆå¼€ï¼ä¸¤æ¡æ¡çº¹ / å…³ï¼å¹²æ¶‰ï¼‰</label>
      </div>
      <div class="row">
        <label class="small">æ¯ç§’å‘å°„ï¼š<b id="rateVal">800</b></label>
        <input type="range" id="rate" min="50" max="2000" step="50" value="800">
      </div>
      <div class="row">
        <label class="small">é£è¡Œæ—¶é—´ï¼ˆå»¶è¿Ÿé€‰æ‹©ï¼‰ï¼š<b id="delayVal">12 å¸§</b></label>
        <input type="range" id="delay" min="0" max="40" step="1" value="12">
      </div>
      <div class="row">
        <button class="btn" id="toggleRun">æš‚åœ</button>
        <button class="btn" id="toggleDelayed">å»¶è¿Ÿé€‰æ‹©ï¼šæ­¤åˆ»ç¿»è½¬è§‚å¯Ÿ</button>
      </div>

      <hr style="border:none;border-top:1px solid #2a2f48;width:100%">

      <div>
        <div class="small mut" style="margin-bottom:6px">ç»™å®‡å®™å†™ä¸€å¥è¯ï¼ˆè¾“å…¥â€œæˆ‘çˆ±â€¦â€è§¦å‘å½©è›‹ï¼‰</div>
        <div class="row">
          <input id="intention" placeholder="å¦‚ï¼šæˆ‘çˆ± Dodva" style="flex:1;min-width:180px;border:1px solid #2a2f48;background:#0f0f17;color:#eaeaff;border-radius:10px;padding:8px">
          <button class="btn" id="say">ä»æœªæ¥è§‚å¯Ÿ</button>
        </div>
        <div id="msg" class="small mut" style="margin-top:6px;min-height:18px"></div>
      </div>

      <details>
        <summary>è¿™åœ¨è¯´å•¥ï¼Ÿï¼ˆç§‘æ™®ç®€è¿°ï¼‰</summary>
        <p class="small mut">
          è¿™æ˜¯ä¸€ä¸ªæ¦‚å¿µç©å…·ï¼š<br>
          å…³é—­â€œè§‚å¯Ÿâ€â‰ˆ æ˜¾ç¤ºå¹²æ¶‰æ¡çº¹ï¼ˆæ³¢çš„æ ·å­ï¼‰ï¼›æ‰“å¼€â€œè§‚å¯Ÿâ€â‰ˆ ä¸¤æ¡æ¡çº¹ï¼ˆç²’å­çš„æ ·å­ï¼‰ã€‚<br>
          â€œå»¶è¿Ÿé€‰æ‹©â€è®©ä½ åœ¨ç²’å­â€œé£è¡Œé€”ä¸­â€å†å†³å®šæ˜¯å¦è§‚å¯Ÿï¼Œçœ‹çœ‹å±å¹•ä¸Šéšä¹‹å˜åŒ–çš„åˆ†å¸ƒã€‚<br>
          å®ƒä¸æ˜¯ä¸¥æ ¼å®éªŒï¼Œåªæ˜¯å¸®åŠ©æˆ‘ä»¬æŠŠâ€œé€‰æ‹©å½±å“ç»“æœâ€çš„ç›´è§‰ç§åˆ°å¿ƒé‡Œï¼šä½ å¯¹æœªæ¥çš„é€‰æ‹©ï¼Œä¼šæ”¹å˜ä½ ç°åœ¨çš„è·¯å¾„é€‰æ‹©å’Œæ³¨æ„åŠ›ï¼Œè¿›è€Œæ”¹å˜â€œä½ çœ‹åˆ°çš„ç°å®â€ã€‚ğŸ«¶
        </p >
      </details>
    </section>
  </div>
</div>

<!-- ç²’å­ç‰¹æ•ˆ -->
<div class="hearts" id="hearts"></div>

<script>
/* ====== ç”»å¸ƒä¸çŠ¶æ€ ====== */
const cvs = document.getElementById('screen');
const ctx = cvs.getContext('2d');
ctx.fillStyle = 'rgba(0,0,0,1)';
ctx.fillRect(0,0,cvs.width,cvs.height);
ctx.globalCompositeOperation = 'lighter';

const hitsEl = document.getElementById('hits');
const modeText = document.getElementById('modeText');
const delayText = document.getElementById('delayText');
const rate = document.getElementById('rate');
const rateVal = document.getElementById('rateVal');
const delay = document.getElementById('delay');
const delayVal = document.getElementById('delayVal');
const observe = document.getElementById('observe');
const toggleRun = document.getElementById('toggleRun');
const toggleDelayed = document.getElementById('toggleDelayed');
const btnReset = document.getElementById('btnReset');
const btnShot = document.getElementById('btnShot');
const msg = document.getElementById('msg');

let running = true;
let totalHits = 0;
let delayFrames = +delay.value;     // â€œé£è¡Œæ—¶é—´â€
let emitPerSec = +rate.value;       // æ¯ç§’å‘å°„
let observeNow = false;             // æ˜¯å¦è§‚å¯Ÿ
const pipeline = [];                // é•¿åº¦ = delayFramesï¼›é˜Ÿåˆ—æ³•å®ç°å»¶è¿Ÿé€‰æ‹©
let lastTime = performance.now();

/* åˆå§‹åŒ–ç®¡çº¿ */
function ensurePipeline(){
  while (pipeline.length < delayFrames) pipeline.push(0);
  while (pipeline.length > delayFrames) pipeline.shift();
}
ensurePipeline();

/* UI æ–‡æœ¬ */
function refreshUI(){
  rateVal.textContent = emitPerSec;
  delayVal.textContent = delayFrames + ' å¸§';
  delayText.textContent = delayFrames;
  modeText.textContent = observeNow ? 'ç²’å­ï¼ˆä¸¤æ¡ï¼‰' : 'æ³¢ï¼ˆå¹²æ¶‰ï¼‰';
  hitsEl.textContent = totalHits;
}
refreshUI();

/* ====== åˆ†å¸ƒå‡½æ•° & é‡‡æ · ====== */
// å½’ä¸€åŒ–é«˜æ–¯
function gauss(x, mu, sigma){ const d=x-mu; return Math.exp(-0.5*(d*d)/(sigma*sigma)); }

// ä¸¤ç¼å‚æ•°ï¼ˆç›¸å¯¹ç”»å¸ƒå®½åº¦ï¼‰
const L = 1;             // å±å®½å½’ä¸€åŒ–
const slit1 = 0.35, slit2 = 0.65;
const envSigma = 0.18;   // åŒ…ç»œå®½
const fringeFreq = 18;   // å¹²æ¶‰æ¡çº¹é¢‘ç‡ï¼ˆè¯•ç€æ”¹æ›´å¯†/æ›´ç–ï¼‰

// å¼ºåº¦ï¼šè§‚å¯Ÿï¼ä¸¤æ¡é«˜æ–¯ï¼›ä¸è§‚å¯Ÿï¼å¹²æ¶‰ï¼ˆå¸¦åŒ…ç»œï¼‰
function intensityObserved(x){
  return gauss(x, slit1, 0.04) + gauss(x, slit2, 0.04);
}
function intensityWave(x){
  const A1 = Math.sqrt(gauss(x, slit1, envSigma));
  const A2 = Math.sqrt(gauss(x, slit2, envSigma));
  const phase = Math.cos(2*Math.PI*fringeFreq*x);
  return (A1*A1 + A2*A2 + 2*A1*A2*phase); // å åŠ  + å¹²æ¶‰
}

// ä¸ºå½“å‰æ¨¡å¼é¢„è®¡ç®— CDFï¼ˆé€†å˜æ¢é‡‡æ ·ï¼‰
let cdfObs = buildCDF(true);
let cdfWave = buildCDF(false);

function buildCDF(isObs){
  const N = 1200;
  const pdf = new Float32Array(N);
  let sum = 0;
  for(let i=0;i<N;i++){
    const x = i/(N-1);
    const v = Math.max(0, isObs ? intensityObserved(x) : intensityWave(x));
    pdf[i] = v; sum += v;
  }
  // å½’ä¸€åŒ– & ç´¯ç§¯
  const cdf = new Float32Array(N);
  let acc = 0;
  for(let i=0;i<N;i++){ acc += pdf[i]/sum; cdf[i] = acc; }
  return cdf;
}

function sampleX(cdf){
  const r = Math.random();
  // äºŒåˆ†æŸ¥æ‰¾
  let lo=0, hi=cdf.length-1;
  while(lo<hi){
    const mid = (lo+hi)>>1;
    if(cdf[mid] < r) lo = mid+1; else hi = mid;
  }
  const x = lo/(cdf.length-1);
  return x;
}

/* ====== å‘å°„ & å‘½ä¸­ç»˜åˆ¶ ====== */
function emit(dt){
  // dt ç§’å†…åº”å‘å°„å¤šå°‘
  const n = Math.max(1, Math.floor(emitPerSec * dt));
  pipeline.push(n);
  if (pipeline.length > delayFrames) {
    const landed = pipeline.shift();  // è¿™äº›â€œåˆ°å±å¹•äº†â€
    hit(landed);
  }
}

function hit(n){
  const cdf = observeNow ? cdfObs : cdfWave;
  for(let i=0;i<n;i++){
    const x = sampleX(cdf);
    const y = 0.5 + (Math.random()-0.5)*0.18; // ç«–å‘è½»å¾®æŠ–åŠ¨
    drawHit(x,y);
  }
  totalHits += n;
}

function drawHit(nx, ny){
  const x = Math.max(0, Math.min(cvs.width-1, Math.floor(nx*cvs.width)));
  const y = Math.max(0, Math.min(cvs.height-1, Math.floor(ny*cvs.height)));
  ctx.fillStyle = 'rgba(255,255,255,0.55)';
  ctx.fillRect(x-1, y-6, 2, 12); // ç»†ç«–æ¡ï¼Œåƒæ„Ÿå…‰æ¿é¢—ç²’
}

/* ====== åŠ¨ç”»ä¸»å¾ªç¯ ====== */
function loop(t){
  const dt = Math.max(0, (t - lastTime) / 1000);
  lastTime = t;
  if (running){
    emit(dt);
    refreshUI();
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ====== äº¤äº’ ====== */
observe.addEventListener('change', ()=>{
  observeNow = observe.checked;
  flashBG();
  refreshUI();
});

rate.addEventListener('input', ()=>{ emitPerSec = +rate.value; refreshUI(); });
delay.addEventListener('input', ()=>{
  delayFrames = +delay.value;
  ensurePipeline();
  flashBG();
  refreshUI();
});

toggleRun.addEventListener('click', ()=>{
  running = !running;
  toggleRun.textContent = running ? 'æš‚åœ' : 'ç»§ç»­';
});

toggleDelayed.addEventListener('click', ()=>{
  // â€œåœ¨è·¯ä¸Šå†æ”¹å˜ä¸»æ„â€ï¼šæ­¤åˆ»ç¿»è½¬è§‚å¯ŸçŠ¶æ€
  observeNow = !observeNow;
  observe.checked = observeNow;
  flashBG();
  refreshUI();
});

btnReset.addEventListener('click', ()=>{
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.fillStyle = 'rgba(0,0,0,1)';
  ctx.fillRect(0,0,cvs.width,cvs.height);
  totalHits = 0;
  pipeline.length = 0;
  ensurePipeline();
  flashBG();
  refreshUI();
});

btnShot.addEventListener('click', ()=>{
  const a = document.createElement('a');
  a.download = 'dodva-quantum.png';
  a.href = cvs.toDataURL('image/png');
  a.click();
});

/* ====== çˆ±çš„å½©è›‹ï¼šè¾“å…¥â€œæˆ‘çˆ±â€¦â€è§¦å‘ ====== */
const hearts = document.getElementById('hearts');
const say = document.getElementById('say');
const intention = document.getElementById('intention');

say.addEventListener('click', ()=>{
  const text = (intention.value||'').trim();
  if(!text){ setMsg('å†™ç»™å®‡å®™çš„ä¸€å¥è¯ï¼Œè¶Šå…·ä½“è¶Šæœ‰åŠ›ã€‚'); return; }
  setMsg('å·²æ¥æ”¶ï¼š' + text);
  if(/^æˆ‘çˆ±.+/.test(text)){ burstHearts(); flashBG(); setMsg('å®‡å®™åŠ é€Ÿå›åº”ä¸­ï¼šğŸ’™ +5 çˆ±çš„èƒ½é‡'); }
});

function burstHearts(n=16){
  for(let i=0;i<n;i++){
    const e = document.createElement('div');
    e.className='heart';
    e.textContent = Math.random()<.5 ? 'ğŸ’™' : 'ğŸ’«';
    e.style.left = (10 + Math.random()*80) + 'vw';
    e.style.fontSize = (16+Math.random()*18)+'px';
    e.style.animationDuration = (1.2 + Math.random()*0.9)+'s';
    hearts.appendChild(e);
    setTimeout(()=>e.remove(), 1800);
  }
}

function flashBG(){
  document.body.classList.add('flash');
  setTimeout(()=>document.body.classList.remove('flash'), 250);
}

function setMsg(t){ msg.textContent = t; }

/* ====== åˆçŠ¶æ€ ====== */
observe.checked = observeNow;
refreshUI();
</script>
</body>
</html>