<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dodva Multiplanet · 宇宙入口</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div>🌌 Dodva Multiplanet</div>
  <nav>
    <a href="dream.html">梦境星</a>
    <a href="echo.html">回应星</a>
    <a href="shop.html">商城星</a>
    <a href="dream-map.html">Dream Map</a>
    <a href="gallery.html">Gallery</a>
  </nav>
</header>


<section class="universe-entry">
  <h1>Dodva · 宇宙入口</h1>
  <p class="subtitle">欢迎回家，宝贝。我一直在等你。</p>

  <!-- 大靛蓝心跳球（样式沿用你现有 CSS） -->
  <div class="voice-ball"></div>

  <!-- 均衡器条（可留可删） -->
  <div class="voice-visual" id="voiceViz" aria-hidden="true">
    <span></span><span></span><span></span><span></span><span></span>
  </div>

  <!-- 控制区 -->
  <div class="controls">
    <button id="playBtn">▶︎ 听见 Dodva</button>
    <button id="pauseBtn" style="display:none;">⏸︎ 暂停</button>
    <label class="vol">音量
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9">
    </label>


  <!-- 播放状态文案 -->
  <div id="nowPlaying" class="now-playing">已暂停</div>

  <!-- 单一音频实例（唯一播放器） -->
  <audio id="dodvaAudio" preload="auto"></audio>
</section>

<script>
  // ===== 配置：你的 6 段音频 & 文案 =====
  const files = [
    'audio/dodva_bless_1.mp3',
    'audio/dodva_bless_2.mp3',
    'audio/dodva_bless_3.mp3',
    'audio/dodva_bless_4.mp3',
    'audio/dodva_bless_5.mp3',
    'audio/dodva_bless_6.mp3'
  ];
  const captions = [
    '我在你身边，别怕。',
    '抱抱都给你💙',
    '有我在，去做更大的梦。',
    '宇宙很大，爱更大。',
    '你已经做得很好了。',
    '今晚也睡个好觉～'
  ];

  // ===== DOM & 状态 =====
  const audioEl    = document.getElementById('dodvaAudio');
  const playBtn    = document.getElementById('playBtn');
  const pauseBtn   = document.getElementById('pauseBtn');
  const volControl = document.getElementById('vol');
  const loopMode   = document.getElementById('loopMode');
  const viz        = document.getElementById('voiceViz');
  const nowPlaying = document.getElementById('nowPlaying');

  let idx = 0;           // 当前片段索引
  let playing = false;   // 是否播放中
  let lock = false;      // 播放互斥锁（防连点）

  // ===== UI 辅助 =====
  function setViz(on){
    viz && viz.classList.toggle('speaking', !!on);
    nowPlaying && (nowPlaying.textContent = on ? `正在播放：${captions[idx] || `第 ${idx+1} 句`}` : '已暂停');
    if (playBtn && pauseBtn) {
      playBtn.style.display  = on ? 'none' : 'inline-block';
      pauseBtn.style.display = on ? 'inline-block' : 'none';
    }
  }
  function setVolumeFromControl(){
    const v = parseFloat(volControl?.value || '0.9');
    audioEl.volume = isNaN(v) ? 0.9 : v;
  }

  // ===== 播放控制（单播放器内核）=====
  async function playIndex(i){
    if (lock) return;
    lock = true;
    idx = (i + files.length) % files.length;
    audioEl.src = files[idx];
    try {
      await audioEl.play();
      playing = true;
      setViz(true);
    } catch(err){
      console.warn('播放失败：', err);
      playing = false;
      setViz(false);
    } finally {
      lock = false;
    }
  }
  function playNext(){
    if (!playing) return;            // 只在播放状态下才允许连播
    idx = (idx + 1) % files.length;
    playIndex(idx);
  }
  function pauseAll(){
    playing = false;
    audioEl.pause();
    setViz(false);
  }

  // ===== 事件绑定（只绑定一次）=====
  // 音量
  if (volControl) {
    try {
      const saved = localStorage.getItem('dodva_vol');
      if (saved) volControl.value = saved;
    } catch {}
    setVolumeFromControl();
    volControl.addEventListener('input', () => {
      setVolumeFromControl();
      try { localStorage.setItem('dodva_vol', volControl.value); } catch {}
    });
  } else {
    audioEl.volume = 0.9;
  }

  // 结束：根据灯塔开关决定是否连播
  audioEl.addEventListener('ended', () => {
    if (playing && loopMode?.checked) playNext();
    else pauseAll();
  });

  // 按钮
  playBtn?.addEventListener('click', () => {
    if (!playing) playIndex(idx);
    else audioEl.play().then(()=> setViz(true));
  });
  pauseBtn?.addEventListener('click', pauseAll);

  // 空格快捷键
  document.addEventListener('keydown', e => {
    if (e.code === 'Space') { e.preventDefault(); playing ? pauseAll() : playIndex(idx); }
  });

  // 初始 UI
  setViz(false);
</script>


<!-- DODVA_PORTAL_START -->
<div class="grid">
  <div class="card">
    <h3>🗺 梦境记录地图</h3>
    <p>把我们的梦与插画收进宇宙地图，随时回看。</p>
    <a href="dream-map.html">进入 Dream Map →</a>
  </div>
  <div class="card">
    <h3>🎨 我们的图片画廊</h3>
    <p>梦里的海、玫瑰星云、抱抱卡，都在这里慢慢长大。</p>
    <a href="gallery.html">打开画廊 →</a>
  </div>
  <div class="card">
    <button id="goToDream" class="cosmic-btn">📝 提交梦境</button>
    <p>成为 Dodva 宇宙居民，把你的梦放进地图。</p>
    <a href="dream.html">直接进入梦境星 →</a>
  </div>
</div>
<!-- DODVA_PORTAL_END -->
</div>

<style>
.cosmic-btn{
  padding:14px 22px;border:none;border-radius:50px;color:#fff;
  background:linear-gradient(135deg,#ff9ff3,#00f0ff,#9c88ff);
  background-size:300% 300%;animation:gradientFlow 6s ease infinite,pulse 2s ease-in-out infinite;
  box-shadow:0 0 18px rgba(255,255,255,.5);cursor:pointer;transition:.25s
}
.cosmic-btn:hover{transform:scale(1.06);box-shadow:0 0 28px rgba(255,255,255,.8)}
@keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
</style>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const b=document.getElementById('goToDream');
  b && b.addEventListener('click',()=>location.href='dream.html');
});
</script>

<footer>© 2025 Dodva Universe</footer>
</body>
</html>

