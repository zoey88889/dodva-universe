<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dodva Tiny Garden 2.0</title>
<style>
:root{
  --bg:#0b0b12; --card:#12121b; --ink:#eaeaff; --mut:#9aa0b3; --line:#2a2f48;
  --ground1:#2a2f32; --ground2:#1b1f24; --accent:#ff9ab3;
}
[data-theme="light"]{
  --bg:#f7f8fc; --card:#ffffff; --ink:#111524; --mut:#56627a; --line:#e7e9f3;
  --ground1:#e7f1e7; --ground2:#d4e2d4; --accent:#6b8cff;
}
[data-theme="pink"]{
  --bg:#140e14; --card:#1b131d; --ink:#ffeef6; --mut:#c7b9c7; --line:#3c2a3e;
  --ground1:#3a2742; --ground2:#271b30; --accent:#ff8cc6;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:860px;margin:0 auto;padding:22px 14px}
h1{margin:0 0 6px;font-size:22px}
.mut{color:var(--mut);font-size:13px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 10px 28px rgba(0,0,0,.25)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{cursor:pointer;border:1px solid var(--line);background:transparent;color:var(--ink);border-radius:10px;padding:8px 12px}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.kpi{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
.pill{border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px}
#stage{height:170px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(var(--card),var(--bg));position:relative;overflow:hidden}
#ground{position:absolute;left:0;right:0;bottom:0;height:52px;background:linear-gradient(var(--ground1),var(--ground2))}
#plant{position:absolute;left:50%;bottom:52px;transform:translateX(-50%);font-size:56px;text-shadow:0 0 8px rgba(255,255,255,.08)}
#drops{position:absolute;inset:0;pointer-events:none}
@keyframes dropFall{from{transform:translateY(-20px)}to{transform:translateY(170px);opacity:0}}
.drop{position:absolute;top:-10px;font-size:18px;animation:dropFall 900ms ease-in forwards}
@keyframes pop{from{transform:translate(-50%,0) scale(.96)}to{transform:translate(-50%,0) scale(1)}}
.pop{animation:pop .22s ease}
.toast{position:fixed;right:16px;bottom:16px;background:rgba(14,14,22,.92);color:#eaeaff;border:1px solid var(--line);padding:10px 12px;border-radius:10px;box-shadow:0 10px 26px rgba(0,0,0,.45);transform:translateY(8px);opacity:0;transition:all .18s ease;z-index:9999}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
select{border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--ink);padding:7px 10px}
.progress{height:10px;background:transparent;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#ffd1ea)}
.footer{margin-top:12px;color:var(--mut);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <div>
      <h1>ğŸŒ± Tiny Garden 2.0</h1>
      <div class="mut" id="desc">æ¯æ—¥æµ‡ä¸€æ¬¡æ°´ï¼Œè¿ç»­ 2 å¤©å‡ä¸€çº§ï¼Œæ–­ç­¾ä¼šæ‰çº§ã€‚</div>
    </div>
    <div class="toolbar">
      <select id="themeSel" title="Theme">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="pink">Pink</option>
      </select>
      <button class="btn" id="shotBtn">ğŸ“¸ å¯¼å‡ºèŠ±å›­å¿«ç…§</button>
      <button class="btn" id="resetBtn">ğŸ—‘ï¸ é‡ç½®èŠ±å›­</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div id="stage">
      <div id="ground"></div>
      <div id="plant">ğŸŒ±</div>
      <div id="drops"></div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="waterBtn">ğŸ’§ ä»Šæ—¥æµ‡æ°´</button>
      <span class="mut" id="tip">æ¯å¤©é™ä¸€æ¬¡ Â· è¿ç»­æ›´æ—ºç››</span>
    </div>

    <div class="kpi">
      <span class="pill">ğŸ”¥ Streak <b id="streak">0</b>d</span>
      <span class="pill">ğŸŒ¸ Stage <b id="level">1</b>/3</span>
      <span class="pill">ğŸ“… Last <b id="last">â€”</b></span>
    </div>

    <div class="progress" style="margin-top:10px">
      <div id="bar" class="bar"></div>
    </div>

    <div class="footer">æœ¬é¡µå•æ–‡ä»¶ï¼Œå¯ç¦»çº¿ä¿å­˜ä½¿ç”¨ï¼ˆçº¯å‰ç«¯ï¼‰ã€‚</div>
  </div>
</div>

<script>
/* ===== è¿·ä½  Toast ===== */
function toast(msg='æç¤º', ms=1500){
  const el=document.createElement('div');
  el.className='toast'; el.textContent=msg;
  document.body.appendChild(el);
  requestAnimationFrame(()=>{ el.style.opacity=1; el.style.transform='none'; });
  setTimeout(()=>{ el.style.opacity=0; el.style.transform='translateY(8px)'; setTimeout(()=>el.remove(), 200); }, ms);
}

/* ===== ä¸»é¢˜æŒä¹…åŒ– ===== */
const THEME_KEY='tg2_theme';
const root=document.documentElement;
const themeSel=document.getElementById('themeSel');
function applyTheme(v){ root.setAttribute('data-theme', v==='light'?'light':v==='pink'?'pink':'dark'); }
applyTheme(localStorage.getItem(THEME_KEY)||'dark');
themeSel.value=(localStorage.getItem(THEME_KEY)||'dark');
themeSel.addEventListener('change',()=>{ localStorage.setItem(THEME_KEY, themeSel.value); applyTheme(themeSel.value); });

/* ===== çŠ¶æ€æŒä¹…åŒ–ï¼ˆæ— ç”¨æˆ·å‚æ•°ï¼‰ ===== */
const NS = k => `tg2_${k}`;
const today = () => new Date().toISOString().slice(0,10);
const S = {
  date:   localStorage.getItem(NS('date')) || '',
  streak: +(localStorage.getItem(NS('streak')) || 0),
  level:  +(localStorage.getItem(NS('level'))  || 0), // 0..2 â†’ ğŸŒ±/ğŸŒ¿/ğŸŒ¸
  xp:     +(localStorage.getItem(NS('xp'))     || 0)  // 0..100 è¿›åº¦æ¡
};
function save(){
  localStorage.setItem(NS('date'), S.date);
  localStorage.setItem(NS('streak'), S.streak);
  localStorage.setItem(NS('level'), S.level);
  localStorage.setItem(NS('xp'), S.xp);
}

/* ===== DOM refs ===== */
const plant = document.getElementById('plant');
const drops = document.getElementById('drops');
const waterBtn = document.getElementById('waterBtn');
const tip = document.getElementById('tip');
const streakEl = document.getElementById('streak');
const levelEl = document.getElementById('level');
const lastEl = document.getElementById('last');
const bar = document.getElementById('bar');
const resetBtn = document.getElementById('resetBtn');
const shotBtn = document.getElementById('shotBtn');

/* ===== è§†è§‰ç´ æ ===== */
const PLANTS = ['ğŸŒ±','ğŸŒ¿','ğŸŒ¸']; // 0..2
function render(){
  plant.textContent = PLANTS[Math.min(S.level, PLANTS.length-1)];
  plant.classList.remove('pop'); void plant.offsetWidth; // reflow
  streakEl.textContent=S.streak;
  levelEl.textContent=(S.level+1);
  lastEl.textContent= S.date || 'â€”';
  // è¿›åº¦æ¡ï¼ˆæ¯æ¬¡æµ‡æ°´ +25xpï¼Œ>=100 å‡ä¸€çº§å¹¶æ¸…é›¶ï¼‰
  bar.style.width = Math.min(100, S.xp) + '%';
  const isToday = S.date === today();
  waterBtn.disabled = isToday;
  waterBtn.textContent = isToday ? 'âœ… ä»Šæ—¥å·²æµ‡' : 'ğŸ’§ ä»Šæ—¥æµ‡æ°´';
  tip.textContent = isToday ? 'æ˜å¤©å†æ¥ä¸€æ»´ï¼ŒèŠ±ä¼šæ›´æ—ºã€‚' : 'æ¯å¤©é™ä¸€æ¬¡ Â· è¿ç»­æ›´æ—ºç››';
}

/* ===== è·¨æ—¥æ‰çº§ï¼ˆä»…åœ¨éä»Šæ—¥é¦–æ¬¡æ¸²æŸ“æ—¶åˆ¤å®šï¼‰ ===== */
(function dayRoll(){
  const t=today();
  if(S.date && S.date!==t){
    const y = new Date(Date.now()-86400000).toISOString().slice(0,10);
    if(S.date!==y){ // ä¸æ˜¯ç´§é‚»æ˜¨å¤© â†’ æ–­ç­¾
      S.level = Math.max(0, S.level-1);
      S.streak = 0;
      S.xp = 0;
      save();
    }
  }
  render();
})();

/* ===== åŠ¨ç”»ï¼šå°é›¨æ»´ ===== */
function rain(n=12){
  for(let i=0;i<n;i++){
    const d=document.createElement('div');
    d.className='drop';
    d.textContent = Math.random()<.85?'ğŸ’§':'âœ¨';
    d.style.left = (10+Math.random()*80)+'%';
    d.style.animationDuration = (700+Math.random()*500)+'ms';
    drops.appendChild(d);
    setTimeout(()=>d.remove(),1000);
  }
}

/* ===== è¡Œä¸ºï¼šæµ‡æ°´ ===== */
waterBtn.addEventListener('click', ()=>{
  const t=today();
  if(S.date===t) return;

  // è¿ç»­åˆ¤å®š
  const y = new Date(Date.now()-86400000).toISOString().slice(0,10);
  const continuous = (S.date===y || !S.date);
  S.streak = continuous? (S.streak+1) : 1;

  // XP è¿›åº¦ï¼šæ¯æ¬¡æµ‡æ°´ +25ï¼›æ»¡ 100 å‡çº§ï¼ˆæœ€å¤š 2ï¼‰
  S.xp += 25;
  if(S.xp>=100){
    S.xp -= 100;
    if(S.level<2) S.level++;
  }

  S.date=t;
  save();
  render();

  rain(16);
  plant.classList.add('pop'); setTimeout(()=>plant.classList.remove('pop'), 250);
  toast('ğŸŒ§ï¸ æ¤ç‰©å–é¥±å•¦ï¼');
});

/* ===== é‡ç½® & å¿«ç…§ ===== */
resetBtn.addEventListener('click', ()=>{
  if(!confirm('ç¡®å®šé‡ç½®èŠ±å›­ï¼Ÿï¼ˆæ•°æ®ä¼šæ¸…ç©ºï¼‰')) return;
  S.date=''; S.streak=0; S.level=0; S.xp=0; save(); render(); toast('å·²é‡ç½®');
});

/* çº¯å‰ç«¯å¿«ç…§ï¼ˆæœ€å°å®ç°ï¼‰ï¼šæŠŠ stage åŒºåŸŸç»˜åˆ¶æˆ PNG */
shotBtn.addEventListener('click', ()=>{
  const node = document.getElementById('stage');
  // ç®€æ˜“æˆªå›¾ï¼šç”¨ SVG foreignObject æ‰“åŒ… node çš„ outerHTMLï¼Œå†ç»˜åˆ¶åˆ° canvas
  const w = node.clientWidth, h = node.clientHeight;
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
    <foreignObject width="100%" height="100%">${new XMLSerializer().serializeToString(node)}</foreignObject>
  </svg>`;
  const url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
  const img = new Image(); img.crossOrigin='anonymous'; img.onload=()=>{
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
    const a=document.createElement('a'); a.download=`tiny-garden-${Date.now()}.png`; a.href=c.toDataURL('image/png'); a.click();
    toast('ğŸ“¦ å·²ä¿å­˜ PNG å¿«ç…§');
  };
  img.src=url;
});
</script>
</body>
</html>