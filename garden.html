<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dodva Tiny Garden 2.0</title>
<style>
:root{
  --bg:#0b0b12; --card:#12121b; --ink:#eaeaff; --mut:#9aa0b3; --line:#2a2f48;
  --ground1:#2a2f32; --ground2:#1b1f24; --accent:#ff9ab3;
}
[data-theme="light"]{
  --bg:#f7f8fc; --card:#ffffff; --ink:#111524; --mut:#56627a; --line:#e7e9f3;
  --ground1:#e7f1e7; --ground2:#d4e2d4; --accent:#6b8cff;
}
[data-theme="pink"]{
  --bg:#140e14; --card:#1b131d; --ink:#ffeef6; --mut:#c7b9c7; --line:#3c2a3e;
  --ground1:#3a2742; --ground2:#271b30; --accent:#ff8cc6;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:860px;margin:0 auto;padding:22px 14px}
h1{margin:0 0 6px;font-size:22px}
.mut{color:var(--mut);font-size:13px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 10px 28px rgba(0,0,0,.25)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{cursor:pointer;border:1px solid var(--line);background:transparent;color:var(--ink);border-radius:10px;padding:8px 12px}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.kpi{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
.pill{border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px}
#stage{height:170px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(var(--card),var(--bg));position:relative;overflow:hidden}
#ground{position:absolute;left:0;right:0;bottom:0;height:52px;background:linear-gradient(var(--ground1),var(--ground2))}
#plant{position:absolute;left:50%;bottom:52px;transform:translateX(-50%);font-size:56px;text-shadow:0 0 8px rgba(255,255,255,.08)}
#drops{position:absolute;inset:0;pointer-events:none}
@keyframes dropFall{from{transform:translateY(-20px)}to{transform:translateY(170px);opacity:0}}
.drop{position:absolute;top:-10px;font-size:18px;animation:dropFall 900ms ease-in forwards}
@keyframes pop{from{transform:translate(-50%,0) scale(.96)}to{transform:translate(-50%,0) scale(1)}}
.pop{animation:pop .22s ease}
.toast{position:fixed;right:16px;bottom:16px;background:rgba(14,14,22,.92);color:#eaeaff;border:1px solid var(--line);padding:10px 12px;border-radius:10px;box-shadow:0 10px 26px rgba(0,0,0,.45);transform:translateY(8px);opacity:0;transition:all .18s ease;z-index:9999}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
select{border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--ink);padding:7px 10px}
.progress{height:10px;background:transparent;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#ffd1ea)}
.footer{margin-top:12px;color:var(--mut);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <div>
      <h1>🌱 Tiny Garden 2.0</h1>
      <div class="mut" id="desc">每日浇一次水，连续 2 天升一级，断签会掉级。</div>
    </div>
    <div class="toolbar">
      <select id="themeSel" title="Theme">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="pink">Pink</option>
      </select>
      <button class="btn" id="shotBtn">📸 导出花园快照</button>
      <button class="btn" id="resetBtn">🗑️ 重置花园</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div id="stage">
      <div id="ground"></div>
      <div id="plant">🌱</div>
      <div id="drops"></div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="waterBtn">💧 今日浇水</button>
      <span class="mut" id="tip">每天限一次 · 连续更旺盛</span>
    </div>

    <div class="kpi">
      <span class="pill">🔥 Streak <b id="streak">0</b>d</span>
      <span class="pill">🌸 Stage <b id="level">1</b>/3</span>
      <span class="pill">📅 Last <b id="last">—</b></span>
    </div>

    <div class="progress" style="margin-top:10px">
      <div id="bar" class="bar"></div>
    </div>

    <div class="footer">本页单文件，可离线保存使用（纯前端）。</div>
  </div>
</div>

<script>
/* ===== 迷你 Toast ===== */
function toast(msg='提示', ms=1500){
  const el=document.createElement('div');
  el.className='toast'; el.textContent=msg;
  document.body.appendChild(el);
  requestAnimationFrame(()=>{ el.style.opacity=1; el.style.transform='none'; });
  setTimeout(()=>{ el.style.opacity=0; el.style.transform='translateY(8px)'; setTimeout(()=>el.remove(), 200); }, ms);
}

/* ===== 主题持久化 ===== */
const THEME_KEY='tg2_theme';
const root=document.documentElement;
const themeSel=document.getElementById('themeSel');
function applyTheme(v){ root.setAttribute('data-theme', v==='light'?'light':v==='pink'?'pink':'dark'); }
applyTheme(localStorage.getItem(THEME_KEY)||'dark');
themeSel.value=(localStorage.getItem(THEME_KEY)||'dark');
themeSel.addEventListener('change',()=>{ localStorage.setItem(THEME_KEY, themeSel.value); applyTheme(themeSel.value); });

/* ===== 状态持久化（无用户参数） ===== */
const NS = k => `tg2_${k}`;
const today = () => new Date().toISOString().slice(0,10);
const S = {
  date:   localStorage.getItem(NS('date')) || '',
  streak: +(localStorage.getItem(NS('streak')) || 0),
  level:  +(localStorage.getItem(NS('level'))  || 0), // 0..2 → 🌱/🌿/🌸
  xp:     +(localStorage.getItem(NS('xp'))     || 0)  // 0..100 进度条
};
function save(){
  localStorage.setItem(NS('date'), S.date);
  localStorage.setItem(NS('streak'), S.streak);
  localStorage.setItem(NS('level'), S.level);
  localStorage.setItem(NS('xp'), S.xp);
}

/* ===== DOM refs ===== */
const plant = document.getElementById('plant');
const drops = document.getElementById('drops');
const waterBtn = document.getElementById('waterBtn');
const tip = document.getElementById('tip');
const streakEl = document.getElementById('streak');
const levelEl = document.getElementById('level');
const lastEl = document.getElementById('last');
const bar = document.getElementById('bar');
const resetBtn = document.getElementById('resetBtn');
const shotBtn = document.getElementById('shotBtn');

/* ===== 视觉素材 ===== */
const PLANTS = ['🌱','🌿','🌸']; // 0..2
function render(){
  plant.textContent = PLANTS[Math.min(S.level, PLANTS.length-1)];
  plant.classList.remove('pop'); void plant.offsetWidth; // reflow
  streakEl.textContent=S.streak;
  levelEl.textContent=(S.level+1);
  lastEl.textContent= S.date || '—';
  // 进度条（每次浇水 +25xp，>=100 升一级并清零）
  bar.style.width = Math.min(100, S.xp) + '%';
  const isToday = S.date === today();
  waterBtn.disabled = isToday;
  waterBtn.textContent = isToday ? '✅ 今日已浇' : '💧 今日浇水';
  tip.textContent = isToday ? '明天再来一滴，花会更旺。' : '每天限一次 · 连续更旺盛';
}

/* ===== 跨日掉级（仅在非今日首次渲染时判定） ===== */
(function dayRoll(){
  const t=today();
  if(S.date && S.date!==t){
    const y = new Date(Date.now()-86400000).toISOString().slice(0,10);
    if(S.date!==y){ // 不是紧邻昨天 → 断签
      S.level = Math.max(0, S.level-1);
      S.streak = 0;
      S.xp = 0;
      save();
    }
  }
  render();
})();

/* ===== 动画：小雨滴 ===== */
function rain(n=12){
  for(let i=0;i<n;i++){
    const d=document.createElement('div');
    d.className='drop';
    d.textContent = Math.random()<.85?'💧':'✨';
    d.style.left = (10+Math.random()*80)+'%';
    d.style.animationDuration = (700+Math.random()*500)+'ms';
    drops.appendChild(d);
    setTimeout(()=>d.remove(),1000);
  }
}

/* ===== 行为：浇水 ===== */
waterBtn.addEventListener('click', ()=>{
  const t=today();
  if(S.date===t) return;

  // 连续判定
  const y = new Date(Date.now()-86400000).toISOString().slice(0,10);
  const continuous = (S.date===y || !S.date);
  S.streak = continuous? (S.streak+1) : 1;

  // XP 进度：每次浇水 +25；满 100 升级（最多 2）
  S.xp += 25;
  if(S.xp>=100){
    S.xp -= 100;
    if(S.level<2) S.level++;
  }

  S.date=t;
  save();
  render();

  rain(16);
  plant.classList.add('pop'); setTimeout(()=>plant.classList.remove('pop'), 250);
  toast('🌧️ 植物喝饱啦！');
});

/* ===== 重置 & 快照 ===== */
resetBtn.addEventListener('click', ()=>{
  if(!confirm('确定重置花园？（数据会清空）')) return;
  S.date=''; S.streak=0; S.level=0; S.xp=0; save(); render(); toast('已重置');
});

/* 纯前端快照（最小实现）：把 stage 区域绘制成 PNG */
shotBtn.addEventListener('click', ()=>{
  const node = document.getElementById('stage');
  // 简易截图：用 SVG foreignObject 打包 node 的 outerHTML，再绘制到 canvas
  const w = node.clientWidth, h = node.clientHeight;
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
    <foreignObject width="100%" height="100%">${new XMLSerializer().serializeToString(node)}</foreignObject>
  </svg>`;
  const url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
  const img = new Image(); img.crossOrigin='anonymous'; img.onload=()=>{
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
    const a=document.createElement('a'); a.download=`tiny-garden-${Date.now()}.png`; a.href=c.toDataURL('image/png'); a.click();
    toast('📦 已保存 PNG 快照');
  };
  img.src=url;
});

</script>
</body>
<!-- ====== Tiny Garden · Plus（贴在 body 尾部即可） ====== -->
<section class="card" id="gardenPlus" style="overflow:hidden;max-width:820px;margin:18px auto">
  <h3>🌼 一寸小花园 · Plus</h3>
  <div class="gp-stage mut" id="gpStage">状态加载中…</div>

  <!-- 花园舞台 -->
  <div id="gpPlot" class="gp-plot">
    <div id="gpGround" class="gp-ground"></div>
    <div id="gpFlower" class="gp-flower">🌸</div>
    <div id="gpFX" class="gp-fx"></div>
    <div id="gpBug" class="gp-bug" hidden>🐛</div>
  </div>

  <!-- 任务区 -->
  <div class="gp-bar">
    <button class="btn" id="gpWater">💧 浇水</button>
    <button class="btn" id="gpSun">☀️ 阳光</button>
    <button class="btn" id="gpFeed">🍃 喂养</button>
    <span class="mut">能量 <b id="gpEnergy">0</b> · 心情 <b id="gpMood">0</b></span>
  </div>

  <!-- 成长条 -->
  <div class="gp-xp">
    <div class="gp-xp__bar" id="gpXPBar"></div>
  </div>
  <div class="mut" style="display:flex;justify-content:space-between;align-items:center">
    <span>成长值（LV.<b id="gpLevel">1</b>）</span>
    <span id="gpBadgeArea" class="gp-badges"></span>
  </div>

  <!-- 事件提示/对话框 -->
  <dialog id="gpDialog" class="gp-dialog">
    <div class="gp-dialog__title">🛰️ 事件中心</div>
    <div class="gp-dialog__text" id="gpDialogText">…</div>
    <div class="gp-dialog__actions" id="gpDialogActions"></div>
  </dialog>
</section>

<style>
  .gp-plot{position:relative;height:200px;border:1px solid #2a2f48;border-radius:12px;
    background:linear-gradient(#0e0f17,#0b0b12); overflow:hidden}
  .gp-ground{position:absolute;left:0;right:0;bottom:0;height:56px;
    background:linear-gradient(#2a2f32,#1b1f24)}
  .gp-flower{position:absolute;left:50%;bottom:56px;transform:translateX(-50%);
    font-size:56px; filter:drop-shadow(0 0 8px rgba(255,255,255,.08))}
  .gp-fx{position:absolute;inset:0;pointer-events:none}
  .gp-bug{position:absolute;left:58%;bottom:116px;font-size:28px;cursor:pointer;user-select:none}
  .gp-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
  .gp-xp{height:10px;border:1px solid #2a2f48;border-radius:999px;overflow:hidden;background:#151520}
  .gp-xp__bar{height:100%;width:0%;background:linear-gradient(90deg,#ff7aa2,#ffd1d1)}
  .gp-dialog{border:1px solid #3b3f59;border-radius:14px;background:#0b0b12;color:#eaeaff;
    padding:14px;max-width:420px}
  .gp-dialog::backdrop{background:rgba(0,0,0,.6)}
  .gp-dialog__title{font-weight:700;margin-bottom:6px}
  .gp-dialog__text{color:#cfe3ff;margin-bottom:10px}
  .gp-dialog__actions{display:flex;gap:8px;flex-wrap:wrap}
  .gp-badges{display:flex;gap:6px;flex-wrap:wrap}
  .gp-badge{border:1px solid #3b3f59;border-radius:999px;padding:2px 8px;font-size:12px;color:#cfe3ff}
  /* 动画 */
  @keyframes bloom { 0%{transform:translateX(-50%) scale(.9)} 60%{transform:translateX(-50%) scale(1.08)}
                     100%{transform:translateX(-50%) scale(1)} }
  .gp-pop{animation:bloom .22s ease}
  @keyframes sparkle { from{transform:translate(-50%,-50%) scale(.8);opacity:1}
                       to{transform:translate(-50%,-140%) scale(1.4);opacity:0} }
  .fx-heart{position:absolute;left:50%;top:46%;transform:translate(-50%,-50%);
    font-size:18px;animation:sparkle .9s ease forwards;pointer-events:none}
  .leaf{position:absolute;top:-10px;font-size:18px;transition:transform .9s ease,opacity .9s;pointer-events:none}
  /* 阳光闪一下 */
  .sun-glow{box-shadow:inset 0 0 80px rgba(255,214,150,.18)}
</style>

<script>
(function GardenPlus(){
  const NS = k => `du_garden_plus_${k}`;
  const S = {
    energy: +(localStorage.getItem(NS('energy'))||0),
    mood:   +(localStorage.getItem(NS('mood'))||0),
    xp:     +(localStorage.getItem(NS('xp'))||0),   // 0~100 循环，满级进化
    level:  +(localStorage.getItem(NS('level'))||1),
    badges: JSON.parse(localStorage.getItem(NS('badges'))||'[]'),
    bugHits: 0,
    lastEvent: +(localStorage.getItem(NS('lastEvent'))||0)
  };

  // DOM
  const el = {
    stage:  document.getElementById('gpStage'),
    plot:   document.getElementById('gpPlot'),
    flower: document.getElementById('gpFlower'),
    fx:     document.getElementById('gpFX'),
    bug:    document.getElementById('gpBug'),
    energy: document.getElementById('gpEnergy'),
    mood:   document.getElementById('gpMood'),
    xpBar:  document.getElementById('gpXPBar'),
    level:  document.getElementById('gpLevel'),
    badge:  document.getElementById('gpBadgeArea'),
    dlg:    document.getElementById('gpDialog'),
    dlgTxt: document.getElementById('gpDialogText'),
    dlgAct: document.getElementById('gpDialogActions'),
    bt: {
      water: document.getElementById('gpWater'),
      sun:   document.getElementById('gpSun'),
      feed:  document.getElementById('gpFeed')
    }
  };

  // 渲染
  function render(){
    el.energy.textContent = S.energy;
    el.mood.textContent   = S.mood;
    el.level.textContent  = S.level;
    el.xpBar.style.width  = (S.xp%100) + '%';
    el.stage.textContent  = `LV.${S.level} · 成长值 ${S.xp%100}/100`;
    el.badge.innerHTML = S.badges.map(b=>`<span class="gp-badge">${b}</span>`).join('');
    localStorage.setItem(NS('energy'), S.energy);
    localStorage.setItem(NS('mood'), S.mood);
    localStorage.setItem(NS('xp'), S.xp);
    localStorage.setItem(NS('level'), S.level);
    localStorage.setItem(NS('badges'), JSON.stringify(S.badges));
  }

  // 轻音效（WebAudio，无外链）
  let AC;
  function ping(freq=540, dur=0.18, vol=0.22){
    try{
      AC = AC || new (window.AudioContext||window.webkitAudioContext)();
      const o = AC.createOscillator(), g = AC.createGain();
      o.type='sine'; o.frequency.value=freq;
      o.connect(g); g.connect(AC.destination);
      g.gain.setValueAtTime(0.0001, AC.currentTime);
      g.gain.exponentialRampToValueAtTime(vol, AC.currentTime+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime+dur);
      o.start(); o.stop(AC.currentTime+dur);
    }catch(e){}
  }

  // 特效
  function hearts(n=12){
    for(let i=0;i<n;i++){
      const d=document.createElement('div');
      d.className='fx-heart';
      d.textContent = Math.random()<.6?'💗':'✨';
      d.style.left = (40 + Math.random()*20) + '%';
      d.style.top  = (40 + Math.random()*20) + '%';
      el.fx.appendChild(d);
      setTimeout(()=>d.remove(), 900);
    }
  }
  function leaf(x){
    const d=document.createElement('div');
    d.className='leaf'; d.textContent = '🍃';
    const px = x || (el.plot.getBoundingClientRect().width/2 + (Math.random()*120-60));
    d.style.left = px + 'px';
    el.fx.appendChild(d);
    requestAnimationFrame(()=>{
      const dy = 120 + Math.random()*40, dx = (Math.random()*60-30);
      d.style.transform = `translate(${dx}px, ${dy}px) rotate(${Math.random()*120-60}deg)`;
      d.style.opacity = 0;
    });
    setTimeout(()=>d.remove(), 900);
  }

  // 成长
  function grow(plus=10){
    S.xp += plus;
    if ((S.xp%100)===0){ // 刚好满100算升级
      S.level++;
      el.flower.classList.add('gp-pop');
      setTimeout(()=> el.flower.classList.remove('gp-pop'), 260);
      hearts(18);
      ping(660, .22, .28);
      badge('成长+1');
    }else{
      ping(600, .18, .2);
    }
    render();
  }

  // 徽章
  function badge(name){
    if (!S.badges.includes(name)){
      S.badges.push(name);
      render();
    }
  }

  // —— 日常任务
  el.bt.water.addEventListener('click', ()=>{
    S.energy += 5; grow(10);
    el.flower.classList.add('gp-pop');
    setTimeout(()=> el.flower.classList.remove('gp-pop'), 220);
    hearts(8);
    ping(560);
  });

  el.bt.sun.addEventListener('click', ()=>{
    S.energy += 5; grow(10);
    el.plot.classList.add('sun-glow');
    setTimeout(()=> el.plot.classList.remove('sun-glow'), 420);
    // “唱歌”= 两个音做个可爱提示
    ping(660,.14,.22); setTimeout(()=> ping(880,.14,.18), 120);
  });

  el.bt.feed.addEventListener('click', ()=>{
    S.mood += 5; grow(10);
    leaf();
    ping(520,.12,.18);
  });

  // —— 突发事件调度（最短 35 秒触发一次，随机在孢子/虫虫之间）
  function scheduleEvent(){
    const now = Date.now();
    if (now - S.lastEvent < 35000) return; // 冷却
    if (Math.random() < 0.18){ // 18% 概率尝试触发
      S.lastEvent = now;
      localStorage.setItem(NS('lastEvent'), S.lastEvent);
      if (Math.random() < 0.5) sporeEvent(); else bugEvent();
    }
  }
  setInterval(scheduleEvent, 4000); // 每 4s 检查一次是否触发

  // —— 孢子侦探器
  function sporeEvent(){
    // 闪烁
    el.plot.classList.add('sun-glow');
    setTimeout(()=> el.plot.classList.remove('sun-glow'), 600);

    openDialog(
      "Dodva：叶片潮湿，孢子要作乱了！",
      [
        {txt:"通风 5 分钟", cb:()=>{
          S.energy += 5; grow(10); badge('孢子守护');
          closeDialog();
        }},
        {txt:"忽略", cb:()=> closeDialog()}
      ]
    );
  }

  // —— 虫虫出现（连点 3 下）
  function bugEvent(){
    S.bugHits = 0;
    el.bug.hidden = false;
    positionBug();
    openDialog("虫虫来了！点它 3 次把它请走～", [{txt:"我来抓 🐞", cb:()=> closeDialog()}]);

    const handler = ()=>{
      S.bugHits++;
      el.bug.textContent = (S.bugHits%2)?'🪲':'🐛';
      el.bug.style.transform = `translate(${(Math.random()*20-10)}px, ${(Math.random()*-10)}px)`;
      ping(480,.08,.18);
      if (S.bugHits>=3){
        el.bug.hidden = true;
        el.bug.removeEventListener('click', handler);
        S.energy += 5; grow(10); badge('虫虫克星');
        hearts(10);
      }
    };
    el.bug.addEventListener('click', handler, {once:false});

    // 15s 自动结束（没打完就溜了）
    setTimeout(()=>{
      if (!el.bug.hidden){
        el.bug.hidden = true;
        el.bug.removeEventListener('click', handler);
        closeDialog();
      }
    }, 15000);
  }
  function positionBug(){
    const W = el.plot.clientWidth, H = el.plot.clientHeight;
    const x = W*0.55 + (Math.random()*W*0.2 - W*0.1);
    const y = H*0.40 + (Math.random()*H*0.1 - H*0.05);
    el.bug.style.left = x+'px';
    el.bug.style.bottom = (H - y) + 'px';
  }

  // —— 对话框
  function openDialog(text, actions){
    el.dlgTxt.textContent = text;
    el.dlgAct.innerHTML = '';
    for (const a of actions){
      const b = document.createElement('button');
      b.className='btn'; b.textContent=a.txt;
      b.onclick = a.cb;
      el.dlgAct.appendChild(b);
    }
    if (!el.dlg.open) el.dlg.showModal();
  }
  function closeDialog(){
    if (el.dlg.open) el.dlg.close();
  }

  // 初始渲染
  render();
  el.stage.textContent = `LV.${S.level} · 成长值 ${S.xp%100}/100`;
})();
</script>
</html>