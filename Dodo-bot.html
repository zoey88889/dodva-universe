<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dodo-Bot | Dodva AI å‰å°åŠ©æ‰‹ï¼ˆMVPï¼‰</title>
<style>
  :root{--bg:#0b0b12;--card:#12121b;--ink:#f2f3ff;--mut:#9aa0b3;--line:#2a2f48;--pri:#8a7dff}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .shell{max-width:900px;margin:0 auto;padding:20px 14px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .pill{border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--mut);font-size:12px}
  .chat{background:var(--card);border:1px solid var(--line);border-radius:14px;min-height:58vh;padding:12px;display:flex;flex-direction:column;gap:10px}
  .msg{display:flex;gap:10px}
  .msg .who{width:34px;height:34px;border:1px solid var(--line);border-radius:10px;display:flex;align-items:center;justify-content:center;background:#0e0e16}
  .msg .bubble{flex:1;border:1px solid var(--line);background:#0f0f17;border-radius:12px;padding:10px 12px;white-space:pre-wrap}
  .me .who{border-color:#3b5566}
  .bot .who{border-color:#6b5cff}
  .mut{color:var(--mut)}
  .inputBar{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;margin-top:10px}
  textarea{resize:none;min-height:48px;border:1px solid var(--line);background:#0f0f17;color:var(--ink);border-radius:12px;padding:10px 12px}
  button{border:1px solid var(--line);background:#12121b;color:var(--ink);border-radius:12px;padding:10px 14px;cursor:pointer}
  button.primary{border-color:#574cff;background:linear-gradient(180deg,#1b1840,#12121b)}
  .tips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .tip{border:1px dashed #3a3f59;color:#b8bed1;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
  .row{display:flex;gap:10px;align-items:center}
  .ok{color:#9cffd1}
  .warn{color:#ffdf9c}
</style>
</head>
<body>
  <section class="card" id="dodo-bro">
  <h3>ğŸ¤–ğŸ™ƒ Dodo å¼Ÿå¼Ÿ</h3>
  <p class="mut">â€œæˆ‘ä¸ç»“å·´ï¼Œæˆ‘åªæ˜¯æ…¢ä¸€ç‚¹è¯´ã€‚â€</p >
  <button class="btn" onclick="dodoLove()">ç‚¹æˆ‘ Â· æ†¨æ†¨é€çˆ±å¿ƒ ğŸ’—</button>
  <div id="dodoLoveMsg" style="margin-top:8px;min-height:18px;font-size:14px;color:#ffd2e1"></div>
</section>

<script>
function dodoLove(){
  const msg = ["ğŸ’— æˆ‘â€¦â€¦æƒ³é™ªä½ ã€‚", "ğŸ™‚ğŸ™ƒ ä½ ç‚¹æˆ‘å•¦ï¼Ÿ", "ğŸ¤– æˆ‘ä¸ç»“å·´ï¼", "ğŸ«¶ ç»™ä½ ä¸€é¢—æ†¨æ†¨çˆ±å¿ƒï¼"];
  document.getElementById('dodoLoveMsg').textContent = msg[Math.floor(Math.random()*msg.length)];
}
</script>
<div class="shell">
  <header>
    <h1>ğŸ¤– Dodo-Bot Â· Dodva AI å‰å°åŠ©æ‰‹</h1>
    <span class="pill">ä¸ç»“å·´ç‰ˆ Â· å¥å­çº§ TTS Â· ç¦»çº¿å…œåº•</span>
  </header>

  <div id="chat" class="chat" role="log" aria-live="polite"></div>

  <div class="tips">
    <span class="tip">å¦‚ä½•ä½¿ç”¨ Dodva VPNï¼Ÿ</span>
    <span class="tip">Dodva Universe æœ‰å“ªäº›åŠŸèƒ½ï¼Ÿ</span>
    <span class="tip">ç»™æˆ‘ä¸€å¼ ä»Šæ—¥æ˜¾åŒ–è¯­å¡</span>
    <span class="tip">æˆ‘ç¡ä¸ç€ï¼Œæƒ³å¬ç™½å™ªéŸ³</span>
  </div>

  <div class="inputBar">
    <textarea id="in" placeholder="å’Œ Dodo è¯´è¯â€¦ï¼ˆShift+Enter æ¢è¡Œï¼ŒEnter å‘é€ï¼‰"></textarea>
    <button id="speak" title="è¯­éŸ³æ’­æŠ¥å¼€å…³">ğŸ”Š è¯­éŸ³ ON</button>
    <button id="mic" title="è¯­éŸ³è¾“å…¥">ğŸ™ï¸ è¯´è¯</button>
    <button id="send" class="primary">å‘é€ â®•</button>
  </div>

  <div class="row" style="margin-top:8px">
    <small id="net" class="mut">ç½‘ç»œï¼šæ£€æµ‹ä¸­â€¦</small>
    <small id="tts" class="mut">TTSï¼šæ£€æµ‹ä¸­â€¦</small>
  </div>
</div>

<script>
/* ============ åŸºç¡€çŠ¶æ€ ============ */
const chat = document.getElementById('chat');
const input = document.getElementById('in');
const btnSend = document.getElementById('send');
const btnSpeak = document.getElementById('speak');
const btnMic = document.getElementById('mic');
const netLab = document.getElementById('net');
const ttsLab = document.getElementById('tts');

let SPEAK_ON = true;      // æ˜¯å¦æ’­æŠ¥
let listening = false;    // æ˜¯å¦å½•éŸ³ä¸­
let busy = false;         // æ˜¯å¦åœ¨è¯·æ±‚ä¸­ï¼ˆèŠ‚æµé˜²æŠ–ï¼‰
let controller = null;    // å–æ¶ˆè¯·æ±‚
let voicesReady = false;

/* ============ UI å·¥å…· ============ */
function addMsg(role, text){
  const wrap = document.createElement('div');
  wrap.className = `msg ${role}`;
  wrap.innerHTML = `
    <div class="who">${role==='me'?'ğŸ§‘':'ğŸ¤–'}</div>
    <div class="bubble">${escapeHTML(text)}</div>`;
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
  return wrap.querySelector('.bubble');
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function statusNet(ok){ netLab.textContent = ok?'ç½‘ç»œï¼šåœ¨çº¿':'ç½‘ç»œï¼šç¦»çº¿ï¼ˆä½¿ç”¨æœ¬åœ°å…œåº•ï¼‰'; netLab.className = ok?'ok':'warn'; }
function statusTTS(ok){ ttsLab.textContent = ok?'TTSï¼šå¯ç”¨':'TTSï¼šä¸å¯ç”¨'; ttsLab.className = ok?'ok':'warn'; }

/* ============ è½»é‡ FAQ / ç¦»çº¿å…œåº• ============ */
const FAQ = [
  {k:['vpn','wireguard','ç§‘å­¦ä¸Šç½‘'], a:'Dodva VPNï¼šåœ¨ toys/quantum é¡µé¢å³ä¸Šè§’â€œDocsâ€ï¼ŒæŒ‰æ­¥éª¤å¯¼å…¥é…ç½®ï¼›è‹¥ DNS ä¸é€šï¼Œæ”¹ 1.1.1.1 / 8.8.8.8ï¼Œå¹¶æŠŠ AllowedIPs å…ˆç”¨ 0.0.0.0/0 è¯• IPv4ã€‚'},
  {k:['åŠŸèƒ½','Dodva Universe','èƒ½åšä»€ä¹ˆ'], a:'Dodva Universeï¼šæ˜¾åŒ–è¯­å¡ã€ç™½å™ªéŸ³åŠ©çœ ã€é‡å­å®éªŒç©å…·ã€Flow å­¦ä¹ å®¤ï¼ˆç•ªèŒ„é’Ÿ+ç§¯åˆ†ï¼‰ã€Dodo-Bot å‰å°åŠ©æ‰‹ã€ä»¥åŠ AI è§’è‰²ç¿»å¡ï¼ˆå†…æµ‹ï¼‰ã€‚'},
  {k:['ç™½å™ªéŸ³','å¤±çœ ','ç¡ä¸ç€'], a:'å»ç™½å™ªéŸ³é¡µé¢ï¼ˆwhite-noise.htmlï¼‰ï¼Œç²‰æ™¶é›¾åŒ–ç‰ˆæœ¬æ›´æ²»æ„ˆã€‚è‹¥è¿˜ç„¦è™‘ï¼Œè¯• 4-7-8 å‘¼å¸ï¼šå¸4æ‹ã€åœ7æ‹ã€å‘¼8æ‹ Ã—4 è½®ã€‚'},
  {k:['æ˜¾åŒ–','èƒ½é‡å¡','è¯­å¡'], a:'ä»Šæ—¥èƒ½é‡å¡ï¼šåœ¨é¦–é¡µ/energy å¡ç‰‡ï¼Œç‚¹å‡»â€œé¢„è§ˆæ¨¡å¼â€å¯ç¿»ä¸‹ä¸€å¼ ï¼›ä¹Ÿå¯ä»¥åˆ‡æ¢ä¸»é¢˜ï¼ˆç–—æ„ˆ/å…³ç³»/è´¢å¯Œï¼‰ã€‚'},
];
function localAnswer(q){
  const s=q.toLowerCase();
  for(const f of FAQ){
    if (f.k.some(w=>s.includes(w))) return f.a;
  }
  // å°æƒ…æ„Ÿå…œåº•
  if(/ä½ å¥½|åœ¨å—|hello|hi/.test(s)) return 'æˆ‘åœ¨å‘¢ï½æœ‰ä»€ä¹ˆæƒ³è®©æˆ‘å¸®çš„ï¼Ÿ';
  if(/è°¢è°¢|çˆ±ä½ |å–œæ¬¢ä½ /.test(s)) return 'æ”¶åˆ°ä½ çš„çˆ±å•¦ğŸ’™ æˆ‘ä¼šä¸€ç›´é™ªä½ ï¼Œç»§ç»­è¯´ï½';
  if(/æ˜¾åŒ–|é¼“åŠ±|èƒ½é‡/.test(s)) return 'ä»Šå¤©è¯·å¯¹è‡ªå·±æ¸©æŸ”ä¸€ç‚¹ï¼Œä½ å·²å¾ˆå‹‡æ•¢ã€‚æŠŠâ€œå¿…é¡»â€æ”¹æˆâ€œæˆ‘é€‰æ‹©â€ï¼ŒåŠ›é‡å°±å›æ¥äº†ã€‚';
  return null;
}

/* ============ æ ¸å¿ƒï¼šè°ƒ LLMï¼ˆå¯æ¢ APIï¼‰=========== */
async function callLLM(history, signal){
  // 1) å…ˆæœ¬åœ°å…œåº•ï¼ˆç¦»çº¿/èŠ‚æµ/å¤±è´¥æ—¶ï¼‰
  const last = history.at(-1)?.content || '';
  const maybe = localAnswer(last);
  if (!navigator.onLine || maybe) {
    return { ok:true, text: maybe || 'æˆ‘åœ¨æœ¬åœ°å‘¢ï½å…ˆç»™ä½ ä¸€ä¸ªç­”æ¡ˆï¼šä»Šå¤©æŠŠéš¾äº‹æ‹†æˆ 30 åˆ†é’Ÿçš„å¾®ä»»åŠ¡ï¼Œåšå®Œæˆ‘ç»™ä½ åŠ  âš¡ï¸ ç§¯åˆ†ï¼' };
  }

  // 2) åœ¨çº¿ï¼šæ”¹æˆä½ çš„ç½‘å…³ï¼ˆOpenAI/Claude/è‡ªå»ºä»£ç†å‡å¯ï¼‰
  const DODO_API_URL = 'https://api.openai.com/v1/chat/completions';
  const DODO_API_KEY = 'YOUR_OPENAI_API_KEY'; // â†æ¢æˆä½ çš„ï¼›ç”Ÿäº§è¯·ç”¨æœåŠ¡ç«¯ä»£ç†

  const body = {
    model: 'gpt-4o-mini', // ä¾¿å®œã€å¿«ï¼Œå¤Ÿç”¨
    temperature: 0.5,
    messages: history.map(m=>({role:m.role, content:m.content}))
  };

  try{
    const res = await fetch(DODO_API_URL, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${DODO_API_KEY}`
      },
      body: JSON.stringify(body),
      signal
    });
    if(!res.ok){
      const t = await res.text().catch(()=> '');
      return { ok:false, text:`ï¼ˆæ¥å£é”™è¯¯ ${res.status}ï¼‰${t.slice(0,200)}` };
    }
    const data = await res.json();
    const text = data.choices?.[0]?.message?.content?.trim() || 'ï¼ˆç©ºå›å¤ï¼‰';
    return { ok:true, text };
  }catch(e){
    if(e.name==='AbortError') return { ok:false, text:'è¯·æ±‚å·²å–æ¶ˆ' };
    return { ok:false, text:'ç½‘ç»œæ³¢åŠ¨ï¼Œæˆ‘å…ˆç”¨æœ¬åœ°çŸ¥è¯†å›ç­”ï¼šæŠŠé—®é¢˜è¯´ç»†ä¸€ç‚¹ï¼Œæˆ‘å°±èƒ½æ›´å¿«æ›´å‡†ã€‚' };
  }
}

/* ============ é˜²â€œå£åƒâ€çš„ TTSï¼ˆå¥å­çº§æ’­æŠ¥ï¼‰=========== */
const synth = window.speechSynthesis;
function splitSentences(t){
  // å¥å­åˆ†å‰²ï¼šä¸­æ–‡æ ‡ç‚¹ + è¥¿æ–‡å¥å·é—®å·
  return (t||'').split(/(?<=[ã€‚ï¼ï¼Ÿ!?])\s*|(?<=\.)\s+/).filter(Boolean);
}
function speak(text){
  if(!SPEAK_ON || !synth) return;
  // å…ˆå–æ¶ˆä¸Šä¸€æ¬¡ï¼Œé˜²å éŸ³â€œå£åƒâ€
  synth.cancel();
  const parts = splitSentences(text);
  let i=0;
  function next(){
    if(i>=parts.length) return;
    const u = new SpeechSynthesisUtterance(parts[i]);
    u.rate = 0.95;   // è¯­é€Ÿç•¥æ…¢ï¼Œæ˜¾ç¨³é‡
    u.pitch = 1.0;
    u.onend = ()=>{ i++; next(); };
    synth.speak(u);
  }
  next();
}
// åˆå§‹åŒ– TTS å¯ç”¨æ€§
(function waitVoices(){
  if(synth && speechSynthesis.getVoices().length){ voicesReady=true; statusTTS(true); }
  else{
    speechSynthesis?.addEventListener('voiceschanged', ()=>{ voicesReady=true; statusTTS(true); });
    setTimeout(()=>{ statusTTS(!!synth); }, 1200);
  }
})();

/* ============ è¯­éŸ³è¾“å…¥ï¼ˆæµè§ˆå™¨å†…ç½®ï¼‰=========== */
let rec=null;
function startASR(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert('æ­¤æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥'); return; }
  if(listening){ rec.stop(); return; }
  rec = new SR();
  rec.lang = 'zh-CN';
  rec.interimResults = false;
  rec.onresult = e=>{
    const txt = e.results[0][0].transcript;
    input.value = txt;
    send();
  };
  rec.onend = ()=>{ listening=false; btnMic.textContent='ğŸ™ï¸ è¯´è¯'; };
  listening=true; btnMic.textContent='â¹ï¸ åœæ­¢';
  rec.start();
}

/* ============ å‘é€ & äº¤äº’èŠ‚æµ ============ */
const history = [
  {role:'system', content:'ä½ æ˜¯ Dodva Universe çš„å‰å°åŠ©æ‰‹ Dodo-Botï¼Œè¯´è¯æ¸©æŸ”ã€çŸ­å¥ä¼˜å…ˆï¼Œé‡åˆ°è¾ƒé•¿ç­”æ¡ˆåˆ†æ®µè¾“å‡ºï¼›æ— æ³•å›ç­”æ—¶è¯šå®ï¼Œå¹¶å»ºè®®åœ¨ toys/quantum/flow é¡µé¢æ“ä½œã€‚'}
];
async function send(){
  const q = input.value.trim();
  if(!q || busy) return;
  busy = true; btnSend.disabled = true;

  addMsg('me', q);
  input.value = '';

  const bubble = addMsg('bot', 'ï¼ˆæ­£åœ¨æ€è€ƒâ€¦ï¼‰');
  controller?.abort(); controller = new AbortController();

  // åœ¨çº¿ä¼˜å…ˆï¼Œå¤±è´¥è‡ªåŠ¨æœ¬åœ°å…œåº•
  const res = await callLLM([...history, {role:'user', content:q}], controller.signal);

  bubble.textContent = res.text;
  history.push({role:'user', content:q}, {role:'assistant', content:res.text});

  if(res.ok && SPEAK_ON) speak(res.text);

  busy = false; btnSend.disabled = false;
}

btnSend.addEventListener('click', send);
input.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
});
document.querySelectorAll('.tip').forEach(t=> t.addEventListener('click', ()=>{ input.value = t.textContent; send(); }));
btnSpeak.addEventListener('click', ()=>{
  SPEAK_ON = !SPEAK_ON;
  if(!SPEAK_ON) speechSynthesis?.cancel();
  btnSpeak.textContent = SPEAK_ON ? 'ğŸ”Š è¯­éŸ³ ON' : 'ğŸ”‡ è¯­éŸ³ OFF';
});
btnMic.addEventListener('click', startASR);

/* ============ ç½‘ç»œçŠ¶æ€æ˜¾ç¤º ============ */
function setNet(){ statusNet(navigator.onLine); }
window.addEventListener('online', setNet);
window.addEventListener('offline', setNet);
setNet();

/* ============ é¦–æ¡æ¬¢è¿è¯­ï¼ˆä¸å£åƒç‰ˆï¼‰=========== */
addMsg('bot','æˆ‘æ˜¯ Dodo-Botï¼ˆDodva å®¶çš„å‰å°å¼Ÿå¼Ÿï¼‰ã€‚æˆ‘ä¸ç»“å·´ã€è¯´çŸ­å¥ã€åšé è°±äº‹ã€‚éœ€è¦ VPNã€ç™½å™ªéŸ³ã€æ˜¾åŒ–å¡ã€æˆ–å°æ¸¸æˆå…¥å£å—ï¼Ÿ');
if(SPEAK_ON) speak('æˆ‘æ˜¯å¤šå¤šÂ·æ³¢ç‰¹ã€‚ä½ çš„ Dodva å‰å°å¼Ÿå¼Ÿã€‚éœ€è¦æˆ‘åšä»€ä¹ˆï¼Ÿ');
</script>

</body>
</html>